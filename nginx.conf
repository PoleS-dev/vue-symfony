events {}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 80;
        server_name localhost;

        root /var/www/symfony/public;
        index index.php;

        # üß± Fichiers statiques Symfony et Vite (build ou proxy)
        location ~ ^/(bundles|css|js|images|fonts)/ {
            try_files $uri $uri/ =404;
            access_log off;
            expires 1y;
            add_header Cache-Control "public";
        }

        # üîÅ Proxy vers Vite en mode d√©veloppement (HMR + assets Vue)
        location /build/ {
            proxy_pass http://front:5173/build/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # üîÅ Proxy WebSocket Vite (n√©cessaire pour HMR)
        location /@vite/ {
            proxy_pass http://front:5173/@vite/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        location /src/ {
            proxy_pass http://front:5173/src/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # üì± Fichiers PWA avec headers appropri√©s
        location ~ ^/spa/manifest\.webmanifest$ {
            root /var/www/symfony/public;
            add_header Content-Type "application/manifest+json";
            add_header Cache-Control "public, max-age=3600";
            access_log off;
            try_files $uri =404;
        }
        
        location ~ ^/spa/(sw\.js|workbox-.*\.js)$ {
            root /var/www/symfony/public;
            add_header Content-Type "application/javascript";
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            access_log off;
            try_files $uri =404;
        }
        
        location ~ ^/spa/.*\.(png|svg|ico)$ {
            root /var/www/symfony/public;
            add_header Cache-Control "public, max-age=31536000";
            access_log off;
            try_files $uri =404;
        }

        # üéØ API backend (si appel √† /api depuis Vue en dev)
        location ^~ /api {
            try_files $uri /index.php$is_args$args;
        }

        # üîÑ Fallback Symfony : toutes les routes pass√©es √† index.php
        location / {
            try_files $uri /index.php$is_args$args;
        }
        # üîÅ Redirige toutes les routes SPA vers index.php pour que Vue Router fonctionne
        location ^~ /spa/ {
            try_files $uri /index.php$is_args$args;
        }
        # üêò Fichiers PHP trait√©s par PHP-FPM (le container "php")
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass php:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            fastcgi_param DOCUMENT_ROOT $realpath_root;
        }

        # üßæ Logs
        access_log /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log warn;
    }
}
